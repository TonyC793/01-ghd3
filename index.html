<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta viewport="width=device-width, initial-scale=1.0">
  <title>Data Visualization</title>
  <style>
    body {
      margin: 0;
      height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      background-color: #f3f3f3;
    }
    svg {
      border: 1px solid #ccc;
    }
    .handwriting {
      font-family: 'Brush Script MT', cursive;
      font-size: 24px;
      fill: black;
    }
  </style>
</head>
<body>
  <svg width="800" height="600"></svg>
  <script src="https://d3js.org/d3.v6.min.js"></script>
  <script>
    // SVG setup
    const svgWidth = 800, svgHeight = 600;
    const svg = d3.select('svg');

    // Text settings
    const text1 = "All work and no play makes Jack a dull boy";
    const text2 = "All play and no work makes Bob a play boy";

    // Add texts
    svg.append('text')
      .attr('x', 100)
      .attr('y', 50)
      .text(text1)
      .attr('class', 'handwriting');

    svg.append('text')
      .attr('x', 100)
      .attr('y', 80)
      .text(text2)
      .attr('class', 'handwriting');

    // Child settings
    const childRadius = 20;
    const childPosition = { x: 100, y: svgHeight - 100 };

    // Tree settings
    const treeWidth = 50;
    const treeHeight = 150;
    const treePosition = { x: svgWidth - 300, y: svgHeight - treeHeight - 100 };

    // Canopy settings (Hexagon)
    const canopySideLength = 70;
    const canopyHeight = Math.sqrt(3) * canopySideLength / 2;
    const canopyCenter = { x: treePosition.x + treeWidth / 2, y: treePosition.y - canopyHeight / 2 };

    // Apple settings
    const appleRadius = 10;
    const applePosition = { x: canopyCenter.x - canopySideLength / 3, y: canopyCenter.y };

    // Arrow settings
    const arrowLength = 90;
    const arrowPosition = { x: childPosition.x + 40, y: childPosition.y };
    let angle = 0;
    // const arrowVelocity = 200;
    // const gravity = 100;

    // Create arrow group
    const arrowGroup = svg.append('g')
    .attr('transform', `translate(${arrowPosition.x},${arrowPosition.y})`);


    // Draw child
    svg.append('circle')
      .attr('cx', childPosition.x)
      .attr('cy', childPosition.y)
      .attr('r', childRadius)
      .style('fill', 'blue');

    // Draw tree
    svg.append('rect')
      .attr('x', treePosition.x)
      .attr('y', treePosition.y)
      .attr('width', treeWidth)
      .attr('height', treeHeight)
      .style('fill', 'brown');

    // Draw canopy
    const canopyPoints = [
      [canopyCenter.x - canopySideLength, canopyCenter.y],
      [canopyCenter.x - canopySideLength / 2, canopyCenter.y - canopyHeight],
      [canopyCenter.x + canopySideLength / 2, canopyCenter.y - canopyHeight],
      [canopyCenter.x + canopySideLength, canopyCenter.y],
      [canopyCenter.x + canopySideLength / 2, canopyCenter.y + canopyHeight],
      [canopyCenter.x - canopySideLength / 2, canopyCenter.y + canopyHeight]
    ].map(p => p.join(',')).join(' ');

    svg.append('polygon')
      .attr('points', canopyPoints)
      .style('fill', 'green');

    // Draw apple
    const apple = svg.append('circle')
      .attr('cx', applePosition.x)
      .attr('cy', applePosition.y)
      .attr('r', appleRadius)
      .style('fill', 'red');

    // Draw arrow
    const arrow = arrowGroup.append('line')
      .attr('x1', 0)
      .attr('y1', 0)
      .attr('x2', arrowLength)
      .attr('y2', 0)
      .attr('stroke-width', 2)
      .style('stroke', 'black');

    // Draw arrow tip (triangle)
    const arrowTip = arrowGroup.append('path')
      .attr('d', `M ${arrowLength} 0 L ${arrowLength - 10} -5 L ${arrowLength - 10} 5 Z`)
      .style('fill', 'black');

    // // Initial transform to position arrow
    // arrowGroup.attr('transform', `translate(${arrowPosition.x},${arrowPosition.y})`);

    // Drag behavior
    const drag = d3.drag()
      .on('start', () => {})
      .on('drag', function(event) {
        // const dx = event.x - arrowPosition.x;
        // const dy = arrowPosition.y - event.y;
        const dx = event.x;
        const dy = event.y;
        angle = Math.atan2(dy, dx) * (180 / Math.PI);

        arrowGroup.attr('transform', `translate(${arrowPosition.x},${arrowPosition.y}) rotate(${angle},${0},${0})`);

        arrowGroup.raise();


        // if (checkCollision(arrowGroup, canopy)) {

        // makeAppleFall(apple);
        // }

      })
      .on('end', function() {
        // Launch arrow with projectile motion
        const velocity = 390;
        const angleRadians = angle * (Math.PI / 180);
        const velocityX = velocity * Math.cos(angleRadians);
        const velocityY = velocity * Math.sin(angleRadians);
        const gravity = 200;

        makeAppleFall(apple);

        arrowGroup.raise();



        d3.timer(function(elapsed) {
          const t = elapsed / 1000;
          const x = velocityX * t;
          const y = velocityY * t + 0.5 * gravity * t * t;
          const dx = arrowLength * Math.cos(angleRadians);
          const dy = arrowLength * Math.sin(angleRadians);
          arrowGroup.attr('transform', `translate(${arrowPosition.x + x - dx},${arrowPosition.y + y - dy}) rotate(${angle},${0},${0})`);
          return y + arrowPosition.y > svgHeight; // Stop the timer if arrow reaches bottom of the SVG
        });
      });

    

    // Apply drag behavior to the arrow tip
    arrowTip.call(drag);


    // 碰撞检测函数
    function checkCollision(arrowGroup, canopy) {
      const arrowBox = arrowGroup.node().getBBox();
      const appleBox = canopy.node().getBBox();
      return (
        arrowBox.x < appleBox.x + appleBox.width &&
        arrowBox.x + arrowBox.width > appleBox.x &&
        arrowBox.y < appleBox.y + appleBox.height &&
        arrowBox.y + arrowBox.height > appleBox.y
      );
    }

    // 苹果下落函数
    function makeAppleFall(apple) {
      const gravity = 0.98;  // 假设重力加速度
      let duration = 0;

      d3.timer(function(elapsed) {
        duration += elapsed;
        const newY = applePosition.y + 0.5 * gravity * Math.pow(duration / 1000, 2);
        apple.attr('cy', newY);
        return newY > svgHeight;  // 如果苹果到达 SVG 底部，则停止计时器
      });
    }

  </script>
</body>
</html>
